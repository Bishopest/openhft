@using OpenHFT.Book.Core;
@using OpenHFT.Core;

@namespace OpenHFT.GUI.Components.Shared

<MudPaper Class="pa-0 d-flex flex-column" Elevation="3" Style="height:80vh; font-family: monospace;">
    @* Added a dedicated header div with its own padding to keep the title looking good. *@
    <div class="px-2 pt-2">
        <MudText Typo="Typo.h6" Align="Align.Center" GutterBottom="true">@(DisplayInstrument is not null ? DisplayInstrument.Symbol : "Selected Instrument")</MudText>
    </div>

    @if (_myCurrentQuote is not null)
    {
        <MudPaper Outlined="true" Class="mx-2 my-1 pa-1 d-flex justify-space-between">
            <MudText Typo="Typo.body2">
                <span class="mud-theme-error-text">Expected Ask:</span>
                <span class="mud-theme-error-text" style="font-weight: bold;">@_myCurrentQuote.Value.Ask.Price.ToDecimal().ToString(_priceFormat)</span>
            </MudText>
            <MudText Typo="Typo.body2">
                <span class="mud-theme-success-text">Expected Bid:</span>
                <span class="mud-theme-success-text" style="font-weight: bold;">@_myCurrentQuote.Value.Bid.Price.ToDecimal().ToString(_priceFormat)</span>
            </MudText>
        </MudPaper>
    }

    <div class="px-4 pb-2">
    
        <MudText Typo="Typo.caption">Grouping: @PriceGrouping.ToString(_priceFormat)</MudText>
        <MudSlider @bind-Value="SelectedMultiplierIndex" 
                   Min="0" 
                   Max="@(_groupingMultipliers.Length - 1)" 
                   Step="1">
            TickSize x @_groupingMultipliers[SelectedMultiplierIndex]
        </MudSlider>
    </div> 
    @if (DisplayInstrument is null)
    {
        @* CHANGE 3: If no instrument is selected, show a clear message in the main area *@
        <div class="d-flex flex-column justify-center align-center fill-height">
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mb-2" />
            <MudText Typo="Typo.h6">No Instrument Selected</MudText>
            <MudText Typo="Typo.body2">Select a strategy from the list to view its order book.</MudText>
        </div>
    }
    else if (_displayLevels.Any())
    {
        
        <div class="table-container" id="@_scrollContainerId">
            <MudSimpleTable Dense="true" Hover="true" Class="price-ladder">
                <thead>
                    <tr>
                        <th style="width: 15%;">My Bid</th>
                        <th style="width: 25%; text-align: right;">Ask Size</th>
                        <th style="width: 20%; text-align: center;">Price</th>
                        <th style="width: 25%; text-align: left;">Bid Size</th>
                        <th style="width: 15%;">My Ask</th>
                    </tr>
                </thead>
                <tbody>
                    @if(_currentOrderBook is not null) {
                        
                        var (bestBid, _) = _currentOrderBook.GetBestBid();
                        var (bestAsk, _) = _currentOrderBook.GetBestAsk();
                        @foreach (var level in _displayLevels)
                        {

                            // Highlight the best bid and ask rows for clarity
                            string rowStyle = "";
                            if (level.Price == bestBid) rowStyle = "background-color: rgba(0, 128, 0, 0.15);";
                            if (level.Price == bestAsk) rowStyle = "background-color: rgba(255, 0, 0, 0.15);";
                            
                            // Highlight the spread area
                            if (level.Price < bestAsk && level.Price > bestBid) rowStyle = "background-color: rgba(245, 245, 220, 0.5);";
                            string priceCellStyle = "font-weight: bold; text-align: center; border-left: 1px solid var(--mud-palette-divider); border-right: 1px solid var(--mud-palette-divider);";
                            if (level.IsMyQuoteAsk)
                            {
                                // If it's our theoretical Ask, add a solid red border on the LEFT.
                                priceCellStyle += " border-left: 3px solid var(--mud-palette-error);";
                            }
                            if (level.IsMyQuoteBid)
                            {
                                // If it's our theoretical Bid, add a solid green border on the RIGHT.
                                priceCellStyle += " border-right: 3px solid var(--mud-palette-success);";
                            }
                            <tr style="@rowStyle">
                                <!-- Column 1: My Quote (Bid) - Empty for now -->
                                <td></td>

                                <!-- Column 2: Ask Size -->
                                <td style="text-align: right; color: #E57373;">
                                    @(level.AskQuantity?.ToDecimal().ToString(_quantityFormat))
                                </td>

                                <!-- Column 3: Price (Center) -->
                                <td style="@priceCellStyle">
                                    @level.Price.ToDecimal().ToString(_priceFormat)
                                </td>

                                <!-- Column 4: Bid Size -->
                                <td style="text-align: left; color: #81C784;">
                                    @(level.BidQuantity?.ToDecimal().ToString(_quantityFormat))
                                </td>

                                <!-- Column 5: My Quote (Ask) - Empty for now -->
                                <td></td>
                            </tr>
                        }
                    }
                </tbody>
            </MudSimpleTable>
        </div>
    }
    else
    {
        <div class="d-flex flex-column justify-center align-center" style="height: 100%;">
            <MudText>Awaiting data for @DisplayInstrument.Symbol...</MudText>
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        </div>
    }
</MudPaper>