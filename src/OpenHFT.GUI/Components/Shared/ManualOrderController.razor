@namespace OpenHFT.GUI.Components.Shared
@using OpenHFT.Core.Models
@using OpenHFT.Core.Instruments
@using OpenHFT.Core.Orders

<MudPaper Class="pa-4" Elevation="2" Style="height: 100%;">
    <MudText Typo="Typo.h6" GutterBottom="true">Manual Order</MudText>

    @* --- Order Input Form --- *@
    <MudForm @ref="_form" Model="@_model">
        <MudStack Spacing="3">
            <MudSelect T="string" @bind-Value="SelectedOmsIdentifier" Label="Target OMS" For="@(() => SelectedOmsIdentifier)"
                       Variant="Variant.Outlined" Required="true" RequiredError="OMS is required.">
                @foreach (var server in _availableOmsServers)
                {
                    <MudSelectItem Value="@server.OmsIdentifier">@server.OmsIdentifier</MudSelectItem>
                }
            </MudSelect>
            <MudAutocomplete T="Instrument" Label="Instrument" SearchFunc="@SearchInstruments"
                ToStringFunc="@ConvertInstrumentToString" @bind-Value="SelectedInstrument" Variant="Variant.Outlined"
                Required="true" ResetValueOnEmptyText="true" CoerceText="true" CoerceValue="true">
                <ItemTemplate Context="instrument">@instrument.Symbol (@instrument.SourceExchange)
                    (@instrument.ProductType)</ItemTemplate>
            </MudAutocomplete>
            <MudSelect T="string" @bind-Value="SelectedBookName" Label="Book Name" For="@(() => SelectedBookName)"
                       Variant="Variant.Outlined" Required="true" RequiredError="Book Name is required.">
                @foreach (var bookName in _availableBookNames)
                {
                    <MudSelectItem Value="@bookName">@bookName</MudSelectItem>
                }
            </MudSelect>
            <MudNumericField T="decimal?" @bind-Value="OrderPriceDecimal" Label="Price" For="@(() => OrderPriceDecimal)"
                             Variant="Variant.Outlined" Required="true" RequiredError="Price is required." Min="0m" />
            <MudNumericField T="decimal?" @Format="@GetQuantityFormat()" Step="@(SelectedInstrument?.LotSize.ToDecimal() ?? 0.00000001m)" 
                             @bind-Value="OrderSizeDecimal" Label="Size (Quantity)" For="@(() => OrderSizeDecimal)"
                             Variant="Variant.Outlined" Required="true" RequiredError="Size is required." Min="0m" />
            <MudSwitch T="bool" Value="@_model.PostOnly" ValueChanged="TogglePostOnly" Label="PostOnly" Color="Color.Success" />
            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                 <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="@(() => HandleSubmit(true))" Class="flex-grow-1">BUY</MudButton>
                 <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="@(() => HandleSubmit(false))" Class="flex-grow-1">SELL</MudButton>
            </MudStack>
        </MudStack>
    </MudForm>

    <MudDivider Class="my-2" />

    @* --- Active Manual Orders Table --- *@
    <MudText Typo="Typo.subtitle1" GutterBottom="true">Active Manual Orders</MudText>
    <div class="flex-grow-1" style="overflow-y: auto;">
        @* Items를 GetDisplayOrders() 메서드로 연결 *@
        <MudTable Items="@GetDisplayOrders()" T="ManualOrderDisplayItem" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh Style="text-align: center;">Actions</MudTh>
                <MudTh>OMS</MudTh>
                <MudTh>Symbol</MudTh>
                <MudTh>Side</MudTh>
                <MudTh>Price</MudTh>
                <MudTh>Leaves Qty</MudTh>
                <MudTh>Status</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Actions" Style="text-align: center;">
                    <MudIconButton Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Error"
                                   OnClick="@((e) => HandleCancelOrderInTable(context))" OnClickStopPropagation="true" />
                </MudTd>
                <MudTd DataLabel="OMS">@context.OmsIdentifier</MudTd>
                <MudTd DataLabel="Symbol">@InstrumentRepository.GetById(context.Report.InstrumentId)?.Symbol</MudTd>
                <MudTd DataLabel="Side" Style="@(context.Report.Side == Side.Buy ? "color: var(--mud-palette-success);" : "color: var(--mud-palette-error);")">
                    @context.Report.Side
                </MudTd>
                <MudTd DataLabel="Price">@context.Report.Price.ToDecimal()</MudTd>
                <MudTd DataLabel="Qty">@context.Report.LeavesQuantity.ToDecimal()</MudTd>
                <MudTd DataLabel="Status">@context.Report.Status</MudTd>
            </RowTemplate>
        </MudTable>
    </div>
</MudPaper>

