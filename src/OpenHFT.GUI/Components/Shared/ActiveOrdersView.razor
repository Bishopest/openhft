@using OpenHFT.Core.Models
@using OpenHFT.GUI.Services
@using OpenHFT.Oms.Api.WebSocket
@implements IDisposable

<MudPaper Class="pa-2 d-flex flex-column" Style="height: 100%;">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
        <MudText Typo="Typo.h6">Active Orders</MudText>
        <MudTextField @bind-Value="_searchString" Placeholder="Filter..." Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small" Class="mt-0" Clearable="true" />
    </MudStack>

    <div class="flex-grow-1" style="overflow-y: auto; min-height: 0;">
        <MudTable Items="@_orders" T="OrderStatusReport" Dense="true" Hover="true" FixedHeader="true" Height="100%"
                  Filter="new Func<OrderStatusReport, bool>(FilterFunc)" SortLabel="Sort By">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortBy="new Func<OrderStatusReport, object>(x => x.Side)">Side</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<OrderStatusReport, object>(x => x.Price.ToDecimal())">Price</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<OrderStatusReport, object>(x => x.LeavesQuantity.ToDecimal())">Qty</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<OrderStatusReport, object>(x => x.Status)">Status</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<OrderStatusReport, object>(x => GetDistanceValue(x))">Dist(bp)</MudTableSortLabel></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Side"
                    Style="@(context.Side == Side.Buy ? "color: var(--mud-palette-success);" : "color: var(--mud-palette-error);")">
                    @context.Side</MudTd>
                <MudTd DataLabel="Price">@context.Price.ToDecimal()</MudTd>
                <MudTd DataLabel="Qty">@context.LeavesQuantity.ToDecimal()</MudTd>
                <MudTd DataLabel="Status">@context.Status</MudTd>
                <MudTd DataLabel="Dist(bp)">@GetDistanceInBps(context)</MudTd>
            </RowTemplate>
        </MudTable>
    </div>
</MudPaper>

@code {
    [Inject] private IOrderCacheService OrderCache { get; set; } = default!;
    [Inject] private IOrderBookManager OrderBookManager { get; set; } = default!;
    
    [Parameter] public string? OmsIdentifier { get; set; }
    [Parameter] public int? InstrumentId { get; set; }

    private string _searchString = "";
    private IEnumerable<OrderStatusReport> _orders = Enumerable.Empty<OrderStatusReport>();
    private string? _previousOmsIdentifier;
    private int? _previousInstrumentId;

    protected override void OnInitialized() => OrderCache.OnOrderUpdated += HandleOrderUpdate;

    private bool FilterFunc(OrderStatusReport order)
    {
        if (string.IsNullOrWhiteSpace(_searchString)) return true;
        if (order.Status.ToString().Contains(_searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if (order.Side.ToString().Contains(_searchString, StringComparison.OrdinalIgnoreCase)) return true;
        return false;
    }

    protected decimal GetDistanceValue(OrderStatusReport order)
    {
        if (InstrumentId is null) return 0;
        var orderBook = OrderBookManager.GetOrderBook(InstrumentId.Value);
        if (orderBook is null) return 0;
        var midPrice = orderBook.GetMidPrice().ToDecimal();
        if (midPrice == 0) return 0;
        return (order.Price.ToDecimal() / midPrice - 1) * 10000;
    }

    protected string GetDistanceInBps(OrderStatusReport order) => GetDistanceValue(order).ToString("F1");

    private void HandleOrderUpdate((string OmsIdentifier, OrderStatusReport Report) args)
    {
        if (args.OmsIdentifier == OmsIdentifier && args.Report.InstrumentId == InstrumentId)
        {
            UpdateOrders();
        }
        InvokeAsync(StateHasChanged);
    }

    private void UpdateOrders()
    {
        _orders = (OmsIdentifier != null && InstrumentId.HasValue)
            ? OrderCache.GetActiveOrders(OmsIdentifier, InstrumentId.Value)
            : Enumerable.Empty<OrderStatusReport>();
    }

    protected override void OnParametersSet()
    {
        if (OmsIdentifier != _previousOmsIdentifier || InstrumentId != _previousInstrumentId)
        {
            _previousOmsIdentifier = OmsIdentifier;
            _previousInstrumentId = InstrumentId;
            UpdateOrders();
        }
    }

    public void Dispose() => OrderCache.OnOrderUpdated -= HandleOrderUpdate;
}