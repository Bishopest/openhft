@using OpenHFT.Book.Core
@using OpenHFT.Core.Models
@using OpenHFT.GUI.Services
@using OpenHFT.Oms.Api.WebSocket
@implements IDisposable

<MudPaper Class="pa-2 d-flex flex-column" Style="height: 100%;">
    <MudText Typo="Typo.h6" GutterBottom="true">Active Orders</MudText>
    <div class="flex-grow-1" style="overflow-y: auto; min-height: 0;">
        <MudTable Items="@_orders" T="OrderStatusReport" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Side</MudTh>
                <MudTh>Price</MudTh>
                <MudTh>Qty</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Dist(bp)</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Side"
                    Style="@(context.Side == Side.Buy ? "color: var(--mud-palette-success);" : "color: var(--mud-palette-error);")">
                    @context.Side</MudTd>
                <MudTd DataLabel="Price">@context.Price.ToDecimal()</MudTd>
                <MudTd DataLabel="Qty">@context.LeavesQuantity.ToDecimal()</MudTd>
                <MudTd DataLabel="Status">@context.Status</MudTd>
                <MudTd DataLabel="Dist(bp)">@GetDistanceInBps(context)</MudTd>
            </RowTemplate>
        </MudTable>
    </div>
</MudPaper>

@code {
    [Inject]
    private IOrderCacheService OrderCache { get; set; } = default!;
    [Inject]
    private IOrderBookManager OrderBookManager { get; set; } = default!;
    // --- CHANGE: Receive OmsIdentifier as a parameter ---
    [Parameter]
    public string? OmsIdentifier { get; set; }

    [Parameter]
    public int? InstrumentId { get; set; }

    private IEnumerable<OrderStatusReport> _orders = Enumerable.Empty<OrderStatusReport>();
    private string? _previousOmsIdentifier;
    private int? _previousInstrumentId;

    protected override void OnInitialized() => OrderCache.OnOrderUpdated += HandleOrderUpdate;

    protected override void OnParametersSet()
    {
        // Check if the key parameters (OMS or Instrument) have changed.
        if (OmsIdentifier != _previousOmsIdentifier || InstrumentId != _previousInstrumentId)
        {
            // If they have changed, clear the current order list immediately.
            // This prevents showing stale data from the previous selection.
            _orders = Enumerable.Empty<OrderStatusReport>();

            // Update the tracked previous values.
            _previousOmsIdentifier = OmsIdentifier;
            _previousInstrumentId = InstrumentId;

            // Now, load the new data.
            UpdateOrders();
        }
    }

    protected string GetDistanceInBps(OrderStatusReport order)
    {
        if (InstrumentId is null) return "-";
        
        var orderBook = OrderBookManager.GetOrderBook(InstrumentId.Value);
        if (orderBook is null) return "-";

        var midPrice = orderBook.GetMidPrice().ToDecimal();
        if (midPrice == 0) return "-";
        
        var orderPrice = order.Price.ToDecimal();
        
        // Formula: (orderPrice / midPrice - 1) * 10000
        var bps = (orderPrice / midPrice - 1) * 10000;
        
        return bps.ToString("F1"); // Format to one decimal place
    }

    private void HandleOrderUpdate((string OmsIdentifier, OrderStatusReport Report) args)
    {
        // Only update if the event is for the currently displayed OMS and Instrument
        if (args.OmsIdentifier == OmsIdentifier && args.Report.InstrumentId == InstrumentId)
        {
            var status = args.Report.Status;

            switch (status)
            {
                case OrderStatus.Cancelled:
                case OrderStatus.Rejected:
                case OrderStatus.Filled:
                    _orders = _orders.Where(o => o.ExchangeOrderId != args.Report.ExchangeOrderId).ToList();
                    break;
                default:
                    if (_orders.Any(o => o.ExchangeOrderId == args.Report.ExchangeOrderId))
                    {
                        _orders = _orders.Select(o => o.ExchangeOrderId == args.Report.ExchangeOrderId ? args.Report : o).ToList();
                    }
                    else
                    {
                        _orders = _orders.Append(args.Report).ToList();
                    }
                    break;
            }
        }

        InvokeAsync(StateHasChanged);
    }

    private void HandleOrderBookUpdate(OrderBook orderBook)
    {
        // If the order book for our currently displayed instrument updates,
        // we need to re-render to update the Dist(bp) column.
        if (InstrumentId.HasValue && orderBook.InstrumentId == InstrumentId.Value)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void UpdateOrders()
    {
        _orders = (OmsIdentifier != null && InstrumentId.HasValue)
        ? OrderCache.GetActiveOrders(OmsIdentifier, InstrumentId.Value)
        : Enumerable.Empty<OrderStatusReport>();

        InvokeAsync(StateHasChanged);
    }

    public void Dispose() => OrderCache.OnOrderUpdated -= HandleOrderUpdate;
}