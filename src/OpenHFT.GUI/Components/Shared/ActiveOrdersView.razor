@using OpenHFT.Core.Models
@using OpenHFT.GUI.Services
@inject IOrderCacheService OrderCache
@implements IDisposable

<MudPaper Class="pa-2 d-flex flex-column" Style="height: 100%;">
    <MudText Typo="Typo.h6" GutterBottom="true">Active Orders</MudText>
    <div class="flex-grow-1" style="overflow-y: auto; min-height: 0;">
        <MudTable Items="@_orders" T="OrderStatusReport" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Side</MudTh>
                <MudTh>Price</MudTh>
                <MudTh>Qty</MudTh>
                <MudTh>Status</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Side"
                    Style="@(context.Side == Side.Buy ? "color: var(--mud-palette-success);" : "color: var(--mud-palette-error);")">
                    @context.Side</MudTd>
                <MudTd DataLabel="Price">@context.Price.ToDecimal()</MudTd>
                <MudTd DataLabel="Qty">@context.Quantity.ToDecimal()</MudTd>
                <MudTd DataLabel="Status">@context.Status</MudTd>
            </RowTemplate>
        </MudTable>
    </div>
</MudPaper>

@code {
    [Parameter]
    public int? InstrumentId { get; set; }

    private IEnumerable<OrderStatusReport> _orders = Enumerable.Empty<OrderStatusReport>();

    protected override void OnInitialized() => OrderCache.OnOrdersUpdated += OnUpdateOrders;
    protected override void OnParametersSet() => RenewOrders();

    private void OnUpdateOrders(object? sender, OrderStatusReport report)
    {
        _orders = InstrumentId.HasValue ? OrderCache.GetActiveOrders(InstrumentId.Value) :
        Enumerable.Empty<OrderStatusReport>();
        StateHasChanged();
    }

    private void RenewOrders()
    {
        _orders = InstrumentId.HasValue ? OrderCache.GetActiveOrders(InstrumentId.Value) :
        Enumerable.Empty<OrderStatusReport>();
        StateHasChanged();
    }

    public void Dispose() => OrderCache.OnOrdersUpdated -= OnUpdateOrders;
}